<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Analytics - Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #4facfe;
            --warning-color: #f6d365;
            --danger-color: #fa709a;
            --dark-color: #2c3e50;
            --light-color: #f8f9fc;
            --border-radius: 12px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --box-shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: var(--box-shadow);
        }

        .navbar-brand {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.5rem;
        }

        .nav-link {
            color: var(--dark-color) !important;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: var(--primary-color) !important;
            transform: translateY(-1px);
        }

        .main-container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            margin: 2rem;
            padding: 2rem;
            box-shadow: var(--box-shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .page-header {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .page-title {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.7));
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--box-shadow-lg);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .stat-icon.visitors {
            background: linear-gradient(135deg, var(--success-color), #00c6ff);
            color: white;
        }

        .stat-icon.countries {
            background: linear-gradient(135deg, var(--warning-color), #feda75);
            color: white;
        }

        .stat-icon.devices {
            background: linear-gradient(135deg, var(--danger-color), #fe9a9e);
            color: white;
        }

        .data-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .card-header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1.5rem;
        }

        .table {
            margin-bottom: 0;
        }

        .table thead th {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            border: none;
            font-weight: 600;
            color: var(--dark-color);
            padding: 1rem;
        }

        .table tbody td {
            padding: 0.75rem 1rem;
            border-color: rgba(0, 0, 0, 0.05);
            vertical-align: middle;
        }

        .btn-action {
            border: none;
            border-radius: 8px;
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 0.3rem;
        }

        .btn-details {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-details:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            color: white;
        }

        .btn-map {
            background: linear-gradient(135deg, var(--success-color), #00c6ff);
            color: white;
        }

        .btn-map:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(79, 172, 254, 0.3);
            color: white;
        }

        .modal-content {
            border: none;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-lg);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .modal-body {
            padding: 2rem;
        }

        .info-section {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-section h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 0.8rem;
        }

        .info-table {
            margin-bottom: 0;
        }

        .info-table th {
            background: none;
            border: none;
            padding: 0.5rem 0;
            font-weight: 600;
            color: var(--dark-color);
            width: 30%;
        }

        .info-table td {
            border: none;
            padding: 0.5rem 0;
            word-break: break-all;
        }

        #map {
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
        }

        .location-badge {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .device-badge {
            background: linear-gradient(135deg, var(--success-color), #00c6ff);
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .dataTables_wrapper .dataTables_length select,
        .dataTables_wrapper .dataTables_filter input {
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
        }

        .dataTables_wrapper .dataTables_paginate .paginate_button {
            border-radius: 8px;
            margin: 0 0.2rem;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>Visitor Analytics
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt me-1"></i>Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="main-container fade-in">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-users me-2"></i>Visitor Analytics Dashboard
            </h1>
            <p class="lead mb-0">Monitor and analyze your website visitor data in real-time</p>
        </div>

        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon visitors">
                    <i class="fas fa-users"></i>
                </div>
                <h3 class="mb-1" id="total-visitors">-</h3>
                <p class="text-muted mb-0">Total Visitors</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon countries">
                    <i class="fas fa-globe"></i>
                </div>
                <h3 class="mb-1" id="unique-countries">-</h3>
                <p class="text-muted mb-0">Countries</p>
            </div>
            <div class="stat-card">
                <div class="stat-icon devices">
                    <i class="fas fa-mobile-alt"></i>
                </div>
                <h3 class="mb-1" id="device-types">-</h3>
                <p class="text-muted mb-0">Device Types</p>
            </div>
        </div>

        <div class="data-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>Visitor Data
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table id="visitorTable" class="table table-hover">
                        <thead>
                            <tr>
                                <th width="50">#</th>
                                <th width="180">Actions</th>
                                <th width="80">Camera</th>
                                <th>IP Address</th>
                                <th>Location</th>
                                <th>Browser</th>
                                <th>OS</th>
                                <th>Device</th>
                                <th>Screen</th>
                                <th>Visit Time</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded via AJAX -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-info-circle me-2"></i>Visitor Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row" id="camera-section" style="display:none;">
                        <div class="col-md-12 mb-3">
                            <div class="info-section text-center">
                                <h6><i class="fas fa-camera me-2"></i>Camera Capture</h6>
                                <img id="modal-camera-image" src="" alt="Camera Capture"
                                    style="max-width: 100%; max-height: 400px; border-radius: 8px;">
                                <p class="mt-2"><small id="modal-camera-time"></small></p>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="info-section">
                                <h6><i class="fas fa-browser me-2"></i>Browser Information</h6>
                                <table class="table info-table">
                                    <tr>
                                        <th>User Agent</th>
                                        <td id="modal-user-agent"></td>
                                    </tr>
                                    <tr>
                                        <th>Language</th>
                                        <td id="modal-language"></td>
                                    </tr>
                                    <tr>
                                        <th>Referrer</th>
                                        <td id="modal-referrer"></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="info-section">
                                <h6><i class="fas fa-fingerprint me-2"></i>Device Fingerprint</h6>
                                <table class="table info-table">
                                    <tr>
                                        <th>Fingerprint</th>
                                        <td id="modal-fingerprint"></td>
                                    </tr>
                                    <tr>
                                        <th>Canvas FP</th>
                                        <td id="modal-canvas-fp"></td>
                                    </tr>
                                    <tr>
                                        <th>WebGL FP</th>
                                        <td id="modal-webgl-fp"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-section">
                                <h6><i class="fas fa-map-marker-alt me-2"></i>Geolocation</h6>
                                <table class="table info-table">
                                    <tr>
                                        <th>Country</th>
                                        <td id="modal-country"></td>
                                    </tr>
                                    <tr>
                                        <th>Region</th>
                                        <td id="modal-region"></td>
                                    </tr>
                                    <tr>
                                        <th>City</th>
                                        <td id="modal-city"></td>
                                    </tr>
                                    <tr>
                                        <th>Coordinates</th>
                                        <td id="modal-coordinates"></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="info-section">
                                <h6><i class="fas fa-microchip me-2"></i>System Information</h6>
                                <table class="table info-table">
                                    <tr>
                                        <th>Timezone</th>
                                        <td id="modal-timezone"></td>
                                    </tr>
                                    <tr>
                                        <th>Battery</th>
                                        <td id="modal-battery"></td>
                                    </tr>
                                    <tr>
                                        <th>Connection</th>
                                        <td id="modal-connection"></td>
                                    </tr>
                                    <tr>
                                        <th>Memory</th>
                                        <td id="modal-memory"></td>
                                    </tr>
                                    <tr>
                                        <th>CPU Cores</th>
                                        <td id="modal-cpu"></td>
                                    </tr>
                                    <tr>
                                        <th>Touch</th>
                                        <td id="modal-touch"></td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal fade" id="mapModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-map me-2"></i>Visitor Location
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-3">
                    <div id="map"></div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Location:</strong> <span id="map-location"></span>
                            </div>
                            <div class="col-md-6">
                                <strong>IP Address:</strong> <span id="map-ip"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let marker;

        $(document).ready(function () {
            // Initialize DataTable
            var table = $('#visitorTable').DataTable({
                "order": [[7, "desc"]],
                "pageLength": 25,
                "processing": true,
                "language": {
                    "processing": '<i class="fas fa-spinner fa-spin"></i> Loading...'
                },
                "ajax": {
                    "url": "/api/visitors",
                    "dataSrc": function (json) {
                        updateStats(json);
                        return json;
                    }
                },
                "order": [[9, "desc"]],  // Sort by visit time (column 9) descending
                "columns": [
                    {
                        "data": null,
                        "render": function (data, type, row, meta) {
                            return meta.row + 1;  // Serial number
                        },
                        "orderable": false
                    },
                    {
                        "data": null,
                        "render": function (data) {
                            let cameraBtn = data.has_camera ?
                                `<button class='btn btn-action camera-btn' title='View Camera' style='background: linear-gradient(135deg, #fa709a, #fe9a9e);'>
                                    <i class='fas fa-camera'></i>
                                </button>` : '';
                            return `
                                <button class='btn btn-action detail-btn' title='View Details'>
                                    <i class='fas fa-info-circle'></i>
                                </button>
                                <button class='btn btn-action map-btn' title='View on Map'>
                                    <i class='fas fa-map-marker-alt'></i>
                                </button>
                                ${cameraBtn}
                                <button class='btn btn-action recapture-camera-btn' title='Recapture Camera' style='background: linear-gradient(135deg, #667eea, #764ba2);'>
                                    <i class='fas fa-camera-retro'></i>
                                </button>
                                <button class='btn btn-action recapture-location-btn' title='Update Location' style='background: linear-gradient(135deg, #4facfe, #00c6ff);'>
                                    <i class='fas fa-sync-alt'></i>
                                </button>
                            `;
                        },
                        "orderable": false
                    },
                    {
                        "data": "has_camera",
                        "render": function (data) {
                            return data ? '<i class="fas fa-camera text-success" title="Camera captured"></i>' : '<i class="fas fa-camera-slash text-muted" title="No camera"></i>';
                        }
                    },
                    {
                        "data": "ip_address",
                        "render": function (data) {
                            return `<code class="text-primary">${data}</code>`;
                        }
                    },
                    {
                        "data": null,
                        "render": function (data) {
                            return `<span class="location-badge">${data.city}, ${data.country}</span>`;
                        }
                    },
                    {
                        "data": null,
                        "render": function (data) {
                            return `${data.browser} ${data.browser_version}`;
                        }
                    },
                    { "data": "operating_system" },
                    {
                        "data": "device",
                        "render": function (data) {
                            return `<span class="device-badge">${data}</span>`;
                        }
                    },
                    { "data": "screen_resolution" },
                    {
                        "data": "visit_time",
                        "render": function (data) {
                            // Data already comes in IST format from backend
                            return data || 'N/A';
                        }
                    }
                ],
                "drawCallback": function () {
                    // Add animation to new rows
                    $('#visitorTable tbody tr').addClass('fade-in');
                }
            });

            // Handle detail button click
            $('#visitorTable tbody').on('click', 'button.detail-btn', function () {
                var data = table.row($(this).closest('tr')).data();
                showVisitorDetails(data);
            });

            // Handle map button click
            $('#visitorTable tbody').on('click', 'button.map-btn', function () {
                var data = table.row($(this).closest('tr')).data();
                showVisitorOnMap(data);
            });

            // Handle camera button click
            $('#visitorTable tbody').on('click', 'button.camera-btn', function () {
                var data = table.row($(this).closest('tr')).data();
                showCameraImage(data);
            });

            // Handle recapture camera button click
            $('#visitorTable tbody').on('click', 'button.recapture-camera-btn', function () {
                var data = table.row($(this).closest('tr')).data();
                recaptureCamera(data);
            });

            // Handle recapture location button click
            $('#visitorTable tbody').on('click', 'button.recapture-location-btn', function () {
                var data = table.row($(this).closest('tr')).data();
                recaptureLocation(data);
            });
        });

        function updateStats(data) {
            const totalVisitors = data.length;
            const uniqueCountries = [...new Set(data.map(visitor => visitor.country))].length;
            const deviceTypes = [...new Set(data.map(visitor => visitor.device))].length;

            $('#total-visitors').text(totalVisitors.toLocaleString());
            $('#unique-countries').text(uniqueCountries);
            $('#device-types').text(deviceTypes);

            // Add pulse animation to stats
            $('.stat-card').addClass('pulse');
            setTimeout(() => $('.stat-card').removeClass('pulse'), 2000);
        }

        function showVisitorDetails(data) {
            // Show camera if available
            if (data.has_camera) {
                $('#camera-section').show();
                fetch(`/api/get_camera/${data.id}`)
                    .then(response => response.json())
                    .then(result => {
                        if (result.success) {
                            $('#modal-camera-image').attr('src', result.camera_image);
                            $('#modal-camera-time').text('Captured: ' + result.timestamp);
                        }
                    });
            } else {
                $('#camera-section').hide();
            }

            $('#modal-user-agent').text(data.user_agent);
            $('#modal-language').text(data.language);
            $('#modal-referrer').text(data.referrer || 'Direct/None');
            $('#modal-country').text(data.country);
            $('#modal-region').text(data.region);
            $('#modal-city').text(data.city);
            $('#modal-coordinates').text(`${data.latitude}, ${data.longitude}`);
            $('#modal-fingerprint').text(data.device_fingerprint || 'N/A');
            $('#modal-canvas-fp').text(data.canvas_fingerprint || 'N/A');
            $('#modal-webgl-fp').text(data.webgl_fingerprint || 'N/A');
            $('#modal-timezone').text(data.timezone || 'N/A');
            $('#modal-battery').text(data.battery_level || 'N/A');
            $('#modal-connection').text(data.connection_type || 'N/A');
            $('#modal-memory').text(data.device_memory || 'N/A');
            $('#modal-cpu').text(data.hardware_concurrency || 'N/A');
            $('#modal-touch').text(data.touch_support ? 'Yes' : 'No');

            var detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
            detailModal.show();
        }

        function showCameraImage(data) {
            fetch(`/api/get_camera/${data.id}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        $('#camera-section').show();
                        $('#modal-camera-image').attr('src', result.camera_image);
                        $('#modal-camera-time').text('Captured: ' + result.timestamp);

                        // Hide other sections for camera-only view
                        $('#modal-user-agent').text(data.user_agent);
                        $('#modal-language').text(data.language);
                        $('#modal-referrer').text(data.referrer || 'Direct/None');
                        $('#modal-country').text(data.country);
                        $('#modal-region').text(data.region);
                        $('#modal-city').text(data.city);
                        $('#modal-coordinates').text(`${data.latitude}, ${data.longitude}`);

                        var detailModal = new bootstrap.Modal(document.getElementById('detailModal'));
                        detailModal.show();
                    }
                });
        }

        function showVisitorOnMap(data) {
            const lat = parseFloat(data.latitude);
            const lng = parseFloat(data.longitude);

            // Update modal info
            $('#map-location').text(`${data.city}, ${data.region}, ${data.country}`);
            $('#map-ip').text(data.ip_address);

            // Show modal
            var mapModal = new bootstrap.Modal(document.getElementById('mapModal'));
            mapModal.show();

            // Initialize map when modal is shown
            $('#mapModal').on('shown.bs.modal', function () {
                if (!map) {
                    map = L.map('map').setView([lat, lng], 13);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: 'Â© OpenStreetMap contributors'
                    }).addTo(map);
                } else {
                    map.setView([lat, lng], 13);
                }

                // Remove existing marker
                if (marker) {
                    map.removeLayer(marker);
                }

                // Add new marker
                marker = L.marker([lat, lng]).addTo(map)
                    .bindPopup(`
                        <div class="text-center">
                            <strong>${data.city}, ${data.country}</strong><br>
                            <small>IP: ${data.ip_address}</small><br>
                            <small>Visited: ${data.visit_time}</small>
                        </div>
                    `)
                    .openPopup();

                // Invalidate size to fix display issues
                setTimeout(() => map.invalidateSize(), 100);
            });
        }

        // Refresh data every 30 seconds
        setInterval(function () {
            $('#visitorTable').DataTable().ajax.reload(null, false);
        }, 30000);

        // Add some sample data for demonstration
        // In real implementation, remove this and use actual API data
        if (window.location.href.includes('claude.ai')) {
            // Sample data for demonstration
            const sampleData = [
                {
                    ip_address: "192.168.1.100",
                    city: "New York",
                    country: "United States",
                    region: "NY",
                    latitude: 40.7128,
                    longitude: -74.0060,
                    browser: "Chrome",
                    browser_version: "118.0",
                    operating_system: "Windows 10",
                    device: "Desktop",
                    screen_resolution: "1920x1080",
                    visit_time: new Date().toISOString(),
                    user_agent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
                    language: "en-US",
                    referrer: "https://google.com"
                },
                {
                    ip_address: "10.0.0.50",
                    city: "London",
                    country: "United Kingdom",
                    region: "England",
                    latitude: 51.5074,
                    longitude: -0.1278,
                    browser: "Firefox",
                    browser_version: "119.0",
                    operating_system: "macOS",
                    device: "Desktop",
                    screen_resolution: "2560x1440",
                    visit_time: new Date(Date.now() - 3600000).toISOString(),
                    user_agent: "Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:119.0)",
                    language: "en-GB",
                    referrer: "https://twitter.com"
                }
            ];

            // Override the DataTable initialization for demo
            setTimeout(() => {
                $('#visitorTable').DataTable().clear().rows.add(sampleData).draw();
                updateStats(sampleData);
            }, 1000);
        }

        // Recapture camera for a visitor
        function recaptureCamera(data) {
            if (!confirm(`Recapture camera for visitor from ${data.ip_address}?\n\nThis will send a request to their browser to capture a new image.`)) {
                return;
            }

            // Show loading message
            alert('Camera recapture request sent!\n\nNote: This feature requires the visitor to still be on the site and grant permission again.');

            // In a real implementation, you would:
            // 1. Send a WebSocket/Server-Sent Event to the visitor's browser
            // 2. Trigger camera capture on their end
            // 3. Upload new image to server
            // For now, this is a placeholder
            console.log('Recapture camera for visitor ID:', data.id);
        }

        // Recapture location for a visitor
        function recaptureLocation(data) {
            if (!confirm(`Update location for visitor from ${data.ip_address}?\n\nThis will send a request to their browser to get their current location.`)) {
                return;
            }

            // Show loading message
            alert('Location update request sent!\n\nNote: This feature requires the visitor to still be on the site and grant permission again.');

            // In a real implementation, you would:
            // 1. Send a WebSocket/Server-Sent Event to the visitor's browser
            // 2. Trigger location request on their end
            // 3. Upload new location to server
            // For now, this is a placeholder
            console.log('Recapture location for visitor ID:', data.id);
        }
    </script>
</body>

</html>